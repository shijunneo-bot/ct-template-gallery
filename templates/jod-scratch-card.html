<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Jod Scratch & Win</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,600;9..40,700;9..40,900&family=JetBrains+Mono:wght@600;700&display=swap');

  *{margin:0;padding:0;box-sizing:border-box}

  :root{
    --jod:#FF9240;
    --jod-light:#FFB06A;
    --jod-dark:#E67A2A;
    --jod-gold:#FFDB06;
    --jod-glow:rgba(255,146,64,0.3);
    --bg:#0C0E14;
    --surface:#161923;
    --surface2:#1E222F;
    --text:#FFFFFF;
    --text-dim:rgba(255,255,255,0.55);
    --text-muted:rgba(255,255,255,0.3);
    --success:#34D399;
  }

  html,body{
    width:100%;height:100%;overflow:hidden;
    font-family:'DM Sans',sans-serif;
    background:var(--bg);color:var(--text);
    -webkit-tap-highlight-color:transparent;
    -webkit-font-smoothing:antialiased;
  }

  .app{
    width:100%;max-width:420px;height:100%;
    margin:0 auto;position:relative;
    display:flex;flex-direction:column;
    align-items:center;justify-content:center;
    padding:24px;
    overflow:hidden;
  }

  /* Ambient glow */
  .app::before{
    content:'';position:absolute;
    top:30%;left:50%;
    width:360px;height:360px;
    transform:translate(-50%,-50%);
    background:radial-gradient(circle,rgba(255,146,64,0.12) 0%,transparent 70%);
    pointer-events:none;
  }

  /* â”€â”€ BRAND HEADER â”€â”€ */
  .brand{
    display:flex;align-items:center;gap:8px;
    margin-bottom:16px;
    position:relative;z-index:2;
  }
  .brand-mark{
    width:32px;height:32px;
    background:linear-gradient(135deg,var(--jod),var(--jod-gold));
    border-radius:8px;
    display:flex;align-items:center;justify-content:center;
    font-size:13px;font-weight:900;color:var(--bg);
  }
  .brand-name{font-size:14px;font-weight:700;}
  .brand-tag{font-size:10px;color:var(--text-dim);}

  /* â”€â”€ PERSONALISED HEADLINE â”€â”€ */
  .headline{
    font-size:22px;font-weight:900;
    text-align:center;
    letter-spacing:-0.5px;
    line-height:1.2;
    margin-bottom:4px;
    position:relative;z-index:2;
  }
  .hl-name{
    background:linear-gradient(90deg,var(--jod),var(--jod-gold));
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
  }

  .subline{
    font-size:13px;color:var(--text-dim);
    text-align:center;margin-bottom:20px;
    position:relative;z-index:2;
  }

  /* â”€â”€ SCRATCH CARD â”€â”€ */
  .card-container{
    position:relative;
    width:100%;max-width:320px;
    aspect-ratio:1.6/1;
    border-radius:16px;
    overflow:hidden;
    box-shadow:
      0 4px 24px rgba(0,0,0,0.4),
      0 0 40px rgba(255,146,64,0.08);
    margin-bottom:20px;
    z-index:2;
  }

  /* Revealed layer (underneath) */
  .card-revealed{
    position:absolute;inset:0;
    background:var(--surface);
    display:flex;flex-direction:column;
    align-items:center;justify-content:center;
    gap:4px;
  }

  .reveal-emoji{font-size:36px;line-height:1;}
  .reveal-label{
    font-size:10px;font-weight:700;
    text-transform:uppercase;letter-spacing:1px;
    color:var(--jod);
  }
  .reveal-code{
    font-family:'JetBrains Mono',monospace;
    font-size:28px;font-weight:700;
    letter-spacing:3px;
    color:var(--text);
  }
  .reveal-desc{
    font-size:11px;color:var(--text-dim);
    max-width:220px;text-align:center;
    line-height:1.3;
  }

  /* Scratch canvas (on top) */
  .scratch-canvas{
    position:absolute;inset:0;
    cursor:pointer;
    touch-action:none;
    z-index:5;
  }

  /* Scratch instruction overlay */
  .scratch-hint{
    position:absolute;inset:0;z-index:6;
    display:flex;flex-direction:column;
    align-items:center;justify-content:center;
    gap:8px;
    pointer-events:none;
    transition:opacity 0.3s ease;
  }
  .scratch-hint.hidden{opacity:0;}

  .hint-icon{
    width:48px;height:48px;
    background:rgba(255,255,255,0.15);
    backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
    border-radius:50%;
    display:flex;align-items:center;justify-content:center;
    font-size:22px;
    animation:hintBounce 1.5s ease-in-out infinite;
  }
  @keyframes hintBounce{
    0%,100%{transform:translateY(0)}
    50%{transform:translateY(-6px)}
  }

  .hint-text{
    font-size:12px;font-weight:700;
    color:rgba(255,255,255,0.8);
    text-transform:uppercase;letter-spacing:1px;
  }

  /* â”€â”€ BUTTONS â”€â”€ */
  .btns{
    display:flex;gap:10px;
    width:100%;max-width:320px;
    position:relative;z-index:2;
  }

  .btn-copy{
    flex:2;height:50px;
    border:none;border-radius:12px;
    background:linear-gradient(135deg,var(--jod) 0%,var(--jod-dark) 100%);
    color:#fff;
    font-family:'DM Sans',sans-serif;
    font-size:14px;font-weight:700;
    cursor:pointer;
    display:flex;align-items:center;justify-content:center;gap:6px;
    box-shadow:0 4px 20px var(--jod-glow);
    transition:all 0.2s ease;
    opacity:0.4;pointer-events:none;
  }
  .btn-copy.ready{opacity:1;pointer-events:auto;}
  .btn-copy:active{transform:scale(0.97);}
  .btn-copy.copied{background:var(--success);box-shadow:0 4px 20px rgba(52,211,153,0.3);}
  .btn-copy svg{width:14px;height:14px;}

  .btn-skip{
    flex:1;height:50px;
    border:1.5px solid var(--surface2);
    border-radius:12px;
    background:transparent;
    color:var(--text-muted);
    font-family:'DM Sans',sans-serif;
    font-size:13px;font-weight:600;
    cursor:pointer;
    transition:all 0.2s ease;
  }
  .btn-skip:active{border-color:var(--text-muted);color:var(--text-dim);}

  .fine{
    font-size:10px;color:var(--text-muted);
    text-align:center;
    margin-top:12px;
    position:relative;z-index:2;
  }

  /* â”€â”€ CELEBRATION â”€â”€ */
  #confetti{
    position:fixed;inset:0;z-index:50;
    pointer-events:none;
  }

  /* â”€â”€ NOISE â”€â”€ */
  .app::after{
    content:'';position:fixed;inset:0;z-index:100;
    pointer-events:none;opacity:0.025;
    background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  }

  /* â”€â”€ ENTRANCE â”€â”€ */
  @keyframes fadeUp{
    from{opacity:0;transform:translateY(20px)}
    to{opacity:1;transform:translateY(0)}
  }
  .brand{animation:fadeUp .5s ease both .1s}
  .headline{animation:fadeUp .5s ease both .15s}
  .subline{animation:fadeUp .5s ease both .2s}
  .card-container{animation:fadeUp .5s ease both .3s}
  .btns{animation:fadeUp .5s ease both .4s}
</style>
</head>
<body>

<div class="app">
  <!-- BRAND -->
  <div class="brand">
    <div class="brand-mark">Jod</div>
    <div>
      <div class="brand-name">JodRewards</div>
      <div class="brand-tag">Scratch & Win</div>
    </div>
  </div>

  <!-- HEADLINE -->
  <div class="headline">
    Hey <span class="hl-name" id="userName">there</span>, you've<br>earned a bonus!
  </div>
  <div class="subline">Scratch the card below to reveal your reward</div>

  <!-- SCRATCH CARD -->
  <div class="card-container" id="cardContainer">
    <!-- Revealed layer -->
    <div class="card-revealed">
      <div class="reveal-emoji">ðŸŽ‰</div>
      <div class="reveal-label">Your Reward</div>
      <div class="reveal-code" id="couponCode"></div>
      <div class="reveal-desc" id="couponDesc"></div>
    </div>

    <!-- Scratch overlay canvas -->
    <canvas class="scratch-canvas" id="scratchCanvas"></canvas>

    <!-- Hint -->
    <div class="scratch-hint" id="scratchHint">
      <div class="hint-icon">ðŸ‘†</div>
      <div class="hint-text">Scratch to reveal</div>
    </div>
  </div>

  <!-- BUTTONS -->
  <div class="btns">
    <button class="btn-copy" id="copyBtn" onclick="copyCode()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
      Copy Code
    </button>
    <button class="btn-skip" onclick="skip()">Skip</button>
  </div>

  <div class="fine">Complete 3 shifts this week to unlock another reward</div>

  <!-- CONFETTI -->
  <canvas id="confetti"></canvas>
</div>

<script>
// =============================================
// CONFIG
// =============================================
var CONFIG = {
  // CleverTap personalisation: replace 'there' with user name
  // In production: document.getElementById('userName').textContent = '@Profile - Name | default: "there"';
  userName: 'there',

  coupon: {
    code: 'JOD30BONUS',
    description: '$30 bonus when you complete your next 3 shifts. Valid 7 days.',
    deeplink: 'jod://rewards'
  },

  // Scratch card visuals
  scratchColor1: '#FF9240',
  scratchColor2: '#FFDB06',
  revealThreshold: 0.50,   // Auto-reveal at 50% scratched

  event: 'Jod_ScratchCard'
};

// =============================================
// STATE
// =============================================
var canvas, ctx, W, H;
var isScratching = false;
var revealed = false;
var scratchStarted = false;
var totalPixels = 0;

// =============================================
// INIT
// =============================================
function init() {
  document.getElementById('couponCode').textContent = CONFIG.coupon.code;
  document.getElementById('couponDesc').textContent = CONFIG.coupon.description;
  document.getElementById('userName').textContent = CONFIG.userName;

  setupCanvas();
  trackEvent('Viewed', { Coupon_Code: CONFIG.coupon.code });
}

// =============================================
// CANVAS SETUP
// =============================================
function setupCanvas() {
  canvas = document.getElementById('scratchCanvas');
  var container = document.getElementById('cardContainer');
  var rect = container.getBoundingClientRect();

  // Use 2x resolution for retina
  var dpr = window.devicePixelRatio || 1;
  W = rect.width;
  H = rect.height;
  canvas.width = W * dpr;
  canvas.height = H * dpr;
  canvas.style.width = W + 'px';
  canvas.style.height = H + 'px';

  ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);

  // Draw scratch surface â€” gradient with pattern
  var grad = ctx.createLinearGradient(0, 0, W, H);
  grad.addColorStop(0, CONFIG.scratchColor1);
  grad.addColorStop(1, CONFIG.scratchColor2);
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, W, H);

  // Add subtle texture dots
  ctx.fillStyle = 'rgba(255,255,255,0.08)';
  for (var i = 0; i < 200; i++) {
    var x = Math.random() * W;
    var y = Math.random() * H;
    var r = Math.random() * 2 + 0.5;
    ctx.beginPath();
    ctx.arc(x, y, r, 0, Math.PI * 2);
    ctx.fill();
  }

  // Add shine streak
  ctx.save();
  ctx.globalAlpha = 0.12;
  ctx.fillStyle = '#fff';
  ctx.beginPath();
  ctx.moveTo(W * 0.3, 0);
  ctx.lineTo(W * 0.5, 0);
  ctx.lineTo(W * 0.2, H);
  ctx.lineTo(0, H);
  ctx.closePath();
  ctx.fill();
  ctx.restore();

  // Add "SCRATCH HERE" text
  ctx.fillStyle = 'rgba(255,255,255,0.5)';
  ctx.font = '700 14px DM Sans, sans-serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.letterSpacing = '2px';

  totalPixels = W * H;

  // Set composite mode for erasing
  ctx.globalCompositeOperation = 'destination-out';

  // Events
  canvas.addEventListener('mousedown', startScratch);
  canvas.addEventListener('mousemove', doScratch);
  canvas.addEventListener('mouseup', stopScratch);
  canvas.addEventListener('mouseleave', stopScratch);

  canvas.addEventListener('touchstart', startScratch, { passive: false });
  canvas.addEventListener('touchmove', doScratch, { passive: false });
  canvas.addEventListener('touchend', stopScratch);
}

function getPos(e) {
  var rect = canvas.getBoundingClientRect();
  if (e.touches) {
    return {
      x: e.touches[0].clientX - rect.left,
      y: e.touches[0].clientY - rect.top
    };
  }
  return { x: e.clientX - rect.left, y: e.clientY - rect.top };
}

function startScratch(e) {
  if (revealed) return;
  e.preventDefault();
  isScratching = true;

  if (!scratchStarted) {
    scratchStarted = true;
    document.getElementById('scratchHint').classList.add('hidden');
    trackEvent('Scratch_Started', {});
  }

  var pos = getPos(e);
  ctx.beginPath();
  ctx.moveTo(pos.x, pos.y);
}

function doScratch(e) {
  if (!isScratching || revealed) return;
  e.preventDefault();
  var pos = getPos(e);

  ctx.lineWidth = 36;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  ctx.lineTo(pos.x, pos.y);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(pos.x, pos.y);

  checkReveal();
}

function stopScratch() {
  isScratching = false;
}

// =============================================
// CHECK REVEAL THRESHOLD
// =============================================
function checkReveal() {
  if (revealed) return;

  var dpr = window.devicePixelRatio || 1;
  var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  var pixels = imageData.data;
  var transparent = 0;
  var total = pixels.length / 4;

  for (var i = 3; i < pixels.length; i += 4) {
    if (pixels[i] === 0) transparent++;
  }

  var percent = transparent / total;

  if (percent >= CONFIG.revealThreshold) {
    revealCard();
  }
}

// =============================================
// REVEAL
// =============================================
function revealCard() {
  if (revealed) return;
  revealed = true;

  // Fade out canvas
  canvas.style.transition = 'opacity 0.5s ease';
  canvas.style.opacity = '0';

  // Enable copy button
  document.getElementById('copyBtn').classList.add('ready');

  // Fire confetti
  setTimeout(fireConfetti, 200);

  trackEvent('Revealed', { Coupon_Code: CONFIG.coupon.code });
}

// =============================================
// COPY TO CLIPBOARD
// =============================================
function copyCode() {
  if (!revealed) return;
  var code = CONFIG.coupon.code;
  var btn = document.getElementById('copyBtn');

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(code).then(function() { showCopied(btn); });
  } else {
    var ta = document.createElement('textarea');
    ta.value = code;
    ta.style.cssText = 'position:fixed;opacity:0';
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    showCopied(btn);
  }

  trackEvent('Copied', { Coupon_Code: code });

  if (typeof CleverTap !== 'undefined') {
    CleverTap.profile.push({ Site: { Last_Coupon_Code: code } });
  }

  // Dismiss after short delay
  setTimeout(function() {
    try { window.location.href = CONFIG.coupon.deeplink; } catch(e) {}
  }, 1200);
}

function showCopied(btn) {
  btn.classList.add('copied');
  btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M20 6L9 17l-5-5"/></svg> Copied!';
}

// =============================================
// SKIP
// =============================================
function skip() {
  trackEvent('Skipped', {
    Was_Revealed: revealed,
    Coupon_Code: CONFIG.coupon.code
  });

  try { window.location.href = 'wzrk://exit'; } catch(e) {}
}

// =============================================
// CONFETTI
// =============================================
function fireConfetti() {
  var c = document.getElementById('confetti');
  var x = c.getContext('2d');
  var dpr = window.devicePixelRatio || 1;
  c.width = c.offsetWidth * dpr;
  c.height = c.offsetHeight * dpr;
  x.scale(dpr, dpr);

  var CW = c.offsetWidth, CH = c.offsetHeight;
  var colors = ['#FF9240', '#FFDB06', '#FFFFFF', '#34D399', '#FF6B6B', '#60A5FA'];
  var pieces = [];

  for (var i = 0; i < 70; i++) {
    pieces.push({
      x: CW / 2 + (Math.random() - 0.5) * CW * 0.6,
      y: CH * 0.5,
      w: Math.random() * 6 + 3,
      h: Math.random() * 4 + 2,
      color: colors[Math.floor(Math.random() * colors.length)],
      vx: (Math.random() - 0.5) * 10,
      vy: -(Math.random() * 8 + 4),
      gravity: 0.15,
      rotation: Math.random() * 360,
      spin: (Math.random() - 0.5) * 10,
      opacity: 1
    });
  }

  var frame = 0, max = 150;

  function animate() {
    if (frame > max) { x.clearRect(0, 0, CW, CH); return; }
    x.clearRect(0, 0, CW, CH);

    pieces.forEach(function(p) {
      p.x += p.vx;
      p.y += p.vy;
      p.vy += p.gravity;
      p.rotation += p.spin;
      p.vx *= 0.98;
      if (frame > max * 0.65) p.opacity = Math.max(0, 1 - (frame - max * 0.65) / (max * 0.35));

      x.save();
      x.translate(p.x, p.y);
      x.rotate(p.rotation * Math.PI / 180);
      x.globalAlpha = p.opacity;
      x.fillStyle = p.color;
      x.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
      x.restore();
    });

    frame++;
    requestAnimationFrame(animate);
  }
  animate();
}

// =============================================
// CLEVERTAP
// =============================================
function trackEvent(action, props) {
  var name = CONFIG.event + '_' + action;
  console.log('[CT]', name, props);
  if (typeof CleverTap !== 'undefined') CleverTap.event.push(name, props);
}

// =============================================
// START
// =============================================
init();
</script>

</body>
</html>
