<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ==================== CONFIGURABLE SETTINGS ==================== -->
  <script>
    const CONFIG = {
      // âœ– Whether to show the X button to close/dismiss
      includeDismissButton: true,

      // ðŸ¢ Brand settings â€” Tune Talk refreshed brand (2025)
      brand: {
        name: "Tune Talk",
        tagline: "#KitaFaham",
        primaryRed: "#E31937",
        primaryRedDark: "#B91430",
        turquoise: "#30D5C8",
        turquoiseLight: "#E6FAF8",
        turquoiseDark: "#1FB5A8",
        dark: "#1A1A2E",
        darkMid: "#2D2D42",
        white: "#FFFFFF",
        greyLight: "#F5F5F7",
        greyMid: "#9CA3AF",
        gold: "#FFD700",
      },

      // ðŸŒˆ Background gradients
      backgrounds: {
        main: "linear-gradient(170deg, #1A1A2E 0%, #2D2D42 30%, #1A1A2E 100%)",
        reward: "linear-gradient(170deg, #0D3330 0%, #1A4A46 40%, #0D3330 100%)",
      },

      // ðŸŽ‰ Confetti on card completion
      enableConfettiOnComplete: true,

      // ðŸ“‡ Stamp card settings
      stampCard: {
        totalStamps: 8,           // Total stamps to fill
        preFilledStamps: 2,       // Endowed progress (welcome bonus)
        currentStamps: 5,         // Current stamps from CleverTap profile (includes pre-filled)
        // In production: pull from CleverTap profile property e.g. Stamp_Card_Count
      },

      // ðŸŽ¯ What earns a stamp
      stampAction: {
        label: "Top up RM10+",
        description: "Every reload of RM10 or more earns you 1 stamp!",
        ctaText: "Top Up Now",
        ctaUrl: "https://www.tunetalk.com/my-account/top-up/",
      },

      // ðŸ… Reward on completion
      reward: {
        title: "5GB Bonus Data + 500 BIG Points!",
        subtitle: "Free bonus data and AirAsia BIG Points â€” redeemable now",
        promoCode: "TTBONUS5GB",
        expiryText: "Valid until 31 March 2026",
        ctaText: "Redeem Now",
        ctaUrl: "https://www.tunetalk.com/jom-enjoy/",
      },

      // ðŸŽ¨ Stamp design â€” emoji or icon for each filled stamp
      stampEmojis: ["ðŸ“±", "âš¡", "ðŸŽµ", "ðŸŽ®", "âœˆï¸", "ðŸŽ", "ðŸ’Ž", "ðŸ†"],
      // Empty stamp placeholder
      emptyStampIcon: "Â·",

      // ðŸ“Š CleverTap event names
      events: {
        stampCardViewed:    "Stamp_Card_Viewed",
        stampCardCtaClick:  "Stamp_Card_CTA_Clicked",
        stampCardCompleted: "Stamp_Card_Completed",
        rewardCopied:       "Stamp_Card_Reward_Copied",
        rewardRedeemed:     "Stamp_Card_Reward_Redeemed",
        stampCardDismissed: "Stamp_Card_Dismissed",
      },
    };
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Tune Talk â€” Stamp Card</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&display=swap');

    /* =============================================
       RESET & BASE
       ============================================= */
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 100%; height: 100%;
      font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
      -webkit-font-smoothing: antialiased;
      overflow: hidden;
      background: #1A1A2E;
    }

    /* =============================================
       MODAL
       ============================================= */
    .modal {
      width: 100%; height: 100%;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 24px 20px;
      transition: background 0.8s ease;
      position: relative; overflow: hidden;
      background: linear-gradient(170deg, #1A1A2E 0%, #2D2D42 30%, #1A1A2E 100%);
    }

    /* Geometric pattern overlay */
    .modal::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background:
        radial-gradient(circle at 15% 20%, rgba(227,25,55,0.06) 0%, transparent 50%),
        radial-gradient(circle at 85% 80%, rgba(48,213,200,0.06) 0%, transparent 50%),
        radial-gradient(circle at 50% 50%, rgba(48,213,200,0.03) 0%, transparent 60%);
      pointer-events: none; z-index: 0;
    }

    /* =============================================
       DISMISS BUTTON
       ============================================= */
    .dismiss-btn {
      position: absolute; top: 16px; right: 16px;
      width: 32px; height: 32px; border-radius: 50%;
      background: rgba(255,255,255,0.08); border: none;
      color: rgba(255,255,255,0.5); font-size: 16px;
      cursor: pointer; z-index: 100;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .dismiss-btn:hover { background: rgba(255,255,255,0.15); color: #fff; }

    /* =============================================
       SCREENS
       ============================================= */
    .screen { display: none; width: 100%; max-width: 360px; position: relative; z-index: 1; }
    .screen.active { display: flex; flex-direction: column; align-items: center; text-align: center; }

    .screen-enter {
      animation: screenSlide 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }
    @keyframes screenSlide {
      from { opacity: 0; transform: translateY(24px) scale(0.96); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* =============================================
       BRAND HEADER
       ============================================= */
    .brand-header {
      display: flex; align-items: center; gap: 8px;
      margin-bottom: 20px;
    }
    .brand-logo {
      width: 28px; height: 28px; border-radius: 8px;
      background: #E31937;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; font-weight: 800; color: #fff;
      box-shadow: 0 2px 8px rgba(227,25,55,0.3);
    }
    .brand-name {
      font-size: 13px; font-weight: 600;
      color: rgba(255,255,255,0.7);
      letter-spacing: 0.3px;
    }

    /* =============================================
       CARD CONTAINER
       ============================================= */
    .stamp-card {
      width: 100%;
      background: linear-gradient(145deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 20px;
      padding: 24px 20px;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    /* Red accent stripe at top of card */
    .stamp-card::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0;
      height: 4px;
      background: linear-gradient(90deg, #E31937 0%, #30D5C8 100%);
    }

    /* =============================================
       CARD TITLE AREA
       ============================================= */
    .card-title {
      font-size: 18px; font-weight: 700;
      color: #FFFFFF;
      margin-bottom: 4px;
    }
    .card-subtitle {
      font-size: 12px; font-weight: 400;
      color: rgba(255,255,255,0.45);
      margin-bottom: 20px;
      line-height: 1.4;
    }

    /* =============================================
       STAMP GRID
       ============================================= */
    .stamp-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .stamp-slot {
      position: relative;
      aspect-ratio: 1;
      border-radius: 16px;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      cursor: default;
    }

    /* Empty state */
    .stamp-slot.empty {
      background: rgba(255,255,255,0.06);
      border: 2px dashed rgba(255,255,255,0.18);
    }
    .stamp-slot.empty .stamp-num {
      font-size: 14px; font-weight: 600;
      color: rgba(255,255,255,0.25);
    }

    /* Filled state */
    .stamp-slot.filled {
      background: linear-gradient(135deg, rgba(48,213,200,0.15) 0%, rgba(48,213,200,0.08) 100%);
      border: 2px solid rgba(48,213,200,0.35);
      box-shadow: 0 2px 12px rgba(48,213,200,0.1);
    }
    .stamp-slot.filled .stamp-emoji {
      font-size: 24px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }
    .stamp-slot.filled .stamp-check {
      position: absolute; top: -4px; right: -4px;
      width: 18px; height: 18px; border-radius: 50%;
      background: #30D5C8;
      display: flex; align-items: center; justify-content: center;
      font-size: 10px; color: #fff; font-weight: 700;
      box-shadow: 0 1px 4px rgba(48,213,200,0.4);
    }

    /* Bonus stamp (endowed progress) */
    .stamp-slot.bonus {
      background: linear-gradient(135deg, rgba(227,25,55,0.12) 0%, rgba(227,25,55,0.06) 100%);
      border: 2px solid rgba(227,25,55,0.3);
    }
    .stamp-slot.bonus .stamp-check { background: #E31937; }
    .stamp-slot.bonus .bonus-tag {
      position: absolute; bottom: -2px;
      font-size: 7px; font-weight: 700;
      color: #E31937;
      letter-spacing: 0.5px; text-transform: uppercase;
      background: rgba(227,25,55,0.1);
      padding: 1px 5px; border-radius: 4px;
    }

    /* Next stamp (pulsing) */
    .stamp-slot.next {
      background: rgba(255,255,255,0.04);
      border: 2px dashed rgba(48,213,200,0.4);
      animation: nextPulse 2s ease-in-out infinite;
    }
    .stamp-slot.next .stamp-num {
      color: rgba(48,213,200,0.6);
    }
    .stamp-slot.next::after {
      content: '?';
      font-size: 18px; font-weight: 700;
      color: rgba(48,213,200,0.35);
    }

    @keyframes nextPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(48,213,200,0.15); }
      50% { box-shadow: 0 0 0 6px rgba(48,213,200,0); }
    }

    /* Stagger entrance */
    .stamp-slot {
      opacity: 0;
      transform: scale(0.7);
    }
    .stamp-slot.animate-in {
      animation: stampPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }
    @keyframes stampPop {
      from { opacity: 0; transform: scale(0.7); }
      to   { opacity: 1; transform: scale(1); }
    }

    /* =============================================
       PROGRESS BAR
       ============================================= */
    .progress-area {
      width: 100%;
      margin-bottom: 16px;
    }
    .progress-header {
      display: flex; justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .progress-text {
      font-size: 13px; font-weight: 600;
      color: rgba(255,255,255,0.8);
    }
    .progress-count {
      font-size: 13px; font-weight: 700;
      color: #30D5C8;
    }
    .progress-bar-bg {
      width: 100%; height: 8px;
      background: rgba(255,255,255,0.08);
      border-radius: 100px;
      overflow: hidden;
      position: relative;
    }
    .progress-bar-fill {
      height: 100%;
      border-radius: 100px;
      background: linear-gradient(90deg, #E31937 0%, #30D5C8 100%);
      transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
    }
    .progress-bar-fill::after {
      content: '';
      position: absolute; right: 0; top: 0;
      width: 20px; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3));
      border-radius: 0 100px 100px 0;
    }

    /* =============================================
       REWARD PREVIEW
       ============================================= */
    .reward-preview {
      display: flex; align-items: center; gap: 10px;
      background: rgba(255,215,0,0.06);
      border: 1px solid rgba(255,215,0,0.15);
      border-radius: 12px;
      padding: 12px 14px;
      width: 100%;
    }
    .reward-preview .rp-icon {
      font-size: 28px;
      flex-shrink: 0;
    }
    .reward-preview .rp-text {
      text-align: left;
    }
    .reward-preview .rp-label {
      font-size: 10px; font-weight: 600;
      color: rgba(255,215,0,0.7);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .reward-preview .rp-title {
      font-size: 13px; font-weight: 600;
      color: rgba(255,255,255,0.85);
      line-height: 1.3;
    }

    /* =============================================
       CTA BUTTONS
       ============================================= */
    .cta-btn {
      width: 100%;
      padding: 15px 24px;
      border-radius: 14px;
      border: none;
      font-family: inherit;
      font-size: 15px; font-weight: 700;
      cursor: pointer;
      transition: all 0.25s ease;
      -webkit-tap-highlight-color: transparent;
      margin-top: 20px;
      position: relative; overflow: hidden;
    }

    .cta-primary {
      background: #E31937;
      color: #FFFFFF;
      box-shadow: 0 4px 20px rgba(227,25,55,0.3);
    }
    .cta-primary:hover {
      background: #B91430;
      transform: translateY(-1px);
      box-shadow: 0 6px 25px rgba(227,25,55,0.4);
    }
    .cta-primary:active { transform: translateY(0) scale(0.98); }

    /* Shimmer */
    .cta-primary::after {
      content: '';
      position: absolute; top: -50%; left: -50%;
      width: 200%; height: 200%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.12), transparent);
      animation: shimmer 3s ease-in-out infinite;
      pointer-events: none;
    }
    @keyframes shimmer {
      0% { transform: translateX(-100%) rotate(25deg); }
      100% { transform: translateX(100%) rotate(25deg); }
    }

    .cta-turquoise {
      background: #30D5C8;
      color: #1A1A2E;
      box-shadow: 0 4px 20px rgba(48,213,200,0.3);
    }
    .cta-turquoise:hover { background: #1FB5A8; }
    .cta-turquoise:active { transform: scale(0.98); }

    /* =============================================
       REWARD SCREEN
       ============================================= */
    .reward-card {
      width: 100%;
      background: linear-gradient(145deg, rgba(48,213,200,0.15) 0%, rgba(48,213,200,0.06) 100%);
      border: 1px solid rgba(48,213,200,0.25);
      border-radius: 20px;
      padding: 28px 24px;
      position: relative; overflow: hidden;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .reward-card::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0;
      height: 4px;
      background: linear-gradient(90deg, #30D5C8 0%, #FFD700 100%);
    }

    .reward-icon {
      font-size: 56px;
      margin-bottom: 12px;
      animation: trophyBounce 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }
    @keyframes trophyBounce {
      from { transform: scale(0) rotate(-15deg); opacity: 0; }
      to   { transform: scale(1) rotate(0deg); opacity: 1; }
    }

    .reward-title {
      font-size: 20px; font-weight: 800;
      color: #FFFFFF;
      margin-bottom: 6px;
      line-height: 1.3;
    }
    .reward-subtitle {
      font-size: 13px; font-weight: 400;
      color: rgba(255,255,255,0.5);
      margin-bottom: 20px;
      line-height: 1.4;
    }

    /* Promo code box */
    .promo-box {
      display: flex; align-items: center;
      background: rgba(0,0,0,0.3);
      border: 1.5px dashed rgba(48,213,200,0.4);
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .promo-box:hover {
      border-color: rgba(48,213,200,0.6);
      background: rgba(0,0,0,0.4);
    }
    .promo-code {
      flex: 1;
      font-size: 20px; font-weight: 800;
      color: #30D5C8;
      letter-spacing: 2px;
      font-family: 'Courier New', monospace;
    }
    .copy-btn {
      font-size: 11px; font-weight: 600;
      color: rgba(255,255,255,0.5);
      background: rgba(255,255,255,0.08);
      border: none; border-radius: 8px;
      padding: 6px 12px;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s ease;
    }
    .copy-btn.copied {
      color: #30D5C8;
      background: rgba(48,213,200,0.15);
    }

    .expiry-text {
      font-size: 11px; font-weight: 400;
      color: rgba(255,255,255,0.3);
      margin-bottom: 4px;
    }

    /* =============================================
       CONFETTI
       ============================================= */
    #confettiCanvas {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none; z-index: 999;
    }

    .hidden { display: none !important; }
  </style>
</head>

<body>
  <canvas id="confettiCanvas"></canvas>

  <div class="modal" id="modal">
    <button class="dismiss-btn" id="dismissBtn" onclick="dismiss()">âœ•</button>

    <!-- =============================================
         SCREEN 1: STAMP CARD (progress view)
         ============================================= -->
    <div class="screen active screen-enter" id="screenStamps">

      <!-- Brand header -->
      <div class="brand-header">
        <div class="brand-logo">T</div>
        <span class="brand-name">Tune Talk Rewards</span>
      </div>

      <!-- Stamp card container -->
      <div class="stamp-card">
        <div class="card-title" id="cardTitle">Your Reward Card</div>
        <div class="card-subtitle" id="cardSubtitle">
          Top up RM10+ to earn stamps. Fill the card, unlock your reward!
        </div>

        <!-- Stamp grid (built by JS) -->
        <div class="stamp-grid" id="stampGrid"></div>

        <!-- Progress bar -->
        <div class="progress-area">
          <div class="progress-header">
            <span class="progress-text" id="progressText">3 more to go!</span>
            <span class="progress-count" id="progressCount">5/8</span>
          </div>
          <div class="progress-bar-bg">
            <div class="progress-bar-fill" id="progressFill" style="width: 0%"></div>
          </div>
        </div>

        <!-- Reward preview -->
        <div class="reward-preview">
          <span class="rp-icon">ðŸŽ</span>
          <div class="rp-text">
            <div class="rp-label">Complete to unlock</div>
            <div class="rp-title" id="rewardPreviewTitle">5GB Bonus Data + 500 BIG Points</div>
          </div>
        </div>
      </div>

      <!-- CTA -->
      <button class="cta-btn cta-primary" id="ctaStamp" onclick="ctaClick()">
        Top Up Now â€” Earn Your Next Stamp
      </button>
    </div>

    <!-- =============================================
         SCREEN 2: REWARD REVEAL (completion view)
         ============================================= -->
    <div class="screen" id="screenReward">

      <div class="brand-header">
        <div class="brand-logo">T</div>
        <span class="brand-name">Tune Talk Rewards</span>
      </div>

      <div class="reward-card">
        <div class="reward-icon" id="rewardIcon">ðŸ†</div>
        <div class="reward-title" id="rewardTitle">Card Complete!</div>
        <div class="reward-subtitle" id="rewardSubtitle">
          You've earned your reward â€” here's your code!
        </div>

        <!-- Promo code -->
        <div class="promo-box" onclick="copyCode()">
          <span class="promo-code" id="promoCode">TTBONUS5GB</span>
          <button class="copy-btn" id="copyBtn">Copy</button>
        </div>
        <div class="expiry-text" id="expiryText">Valid until 31 March 2026</div>
      </div>

      <!-- Redeem CTA -->
      <button class="cta-btn cta-turquoise" onclick="redeemClick()">
        Redeem Now
      </button>

      <!-- Start new card -->
      <button class="cta-btn" style="background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.5);box-shadow:none;margin-top:10px;font-size:13px;" onclick="dismiss()">
        I'll redeem later
      </button>
    </div>
  </div>

  <!-- Confetti library -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <script>
    // =============================================
    // STATE
    // =============================================
    const { totalStamps, preFilledStamps, currentStamps } = CONFIG.stampCard;
    const isComplete = currentStamps >= totalStamps;

    // =============================================
    // RENDER STAMP GRID
    // =============================================
    function renderStampGrid() {
      const grid = document.getElementById('stampGrid');
      grid.innerHTML = '';

      for (let i = 0; i < totalStamps; i++) {
        const slot = document.createElement('div');
        slot.className = 'stamp-slot';

        const isBonus = i < preFilledStamps;
        const isFilled = i < currentStamps;
        const isNext = i === currentStamps;

        if (isFilled && isBonus) {
          slot.classList.add('filled', 'bonus');
          slot.innerHTML = `
            <span class="stamp-emoji">${CONFIG.stampEmojis[i]}</span>
            <div class="stamp-check">âœ“</div>
            <span class="bonus-tag">Bonus</span>
          `;
        } else if (isFilled) {
          slot.classList.add('filled');
          slot.innerHTML = `
            <span class="stamp-emoji">${CONFIG.stampEmojis[i]}</span>
            <div class="stamp-check">âœ“</div>
          `;
        } else if (isNext && !isComplete) {
          slot.classList.add('next');
        } else {
          slot.classList.add('empty');
          slot.innerHTML = `<span class="stamp-num">${i + 1}</span>`;
        }

        grid.appendChild(slot);

        // Stagger animation
        setTimeout(() => {
          slot.classList.add('animate-in');
        }, 80 * i);
      }
    }

    // =============================================
    // RENDER PROGRESS
    // =============================================
    function renderProgress() {
      const remaining = totalStamps - currentStamps;
      const pct = Math.min((currentStamps / totalStamps) * 100, 100);

      document.getElementById('progressCount').textContent =
        `${currentStamps}/${totalStamps}`;

      document.getElementById('progressText').textContent =
        remaining > 0
          ? `${remaining} more to go!`
          : 'Card complete!';

      // Animate progress bar
      setTimeout(() => {
        document.getElementById('progressFill').style.width = pct + '%';
      }, 400);

      // Reward preview title
      document.getElementById('rewardPreviewTitle').textContent =
        CONFIG.reward.title;
    }

    // =============================================
    // SHOW APPROPRIATE SCREEN
    // =============================================
    function init() {
      // Dismiss button
      if (!CONFIG.includeDismissButton) {
        document.getElementById('dismissBtn').classList.add('hidden');
      }

      if (isComplete) {
        // Show reward screen
        showRewardScreen();
      } else {
        // Show stamp card
        renderStampGrid();
        renderProgress();

        // Update CTA text based on remaining
        const remaining = totalStamps - currentStamps;
        const ctaEl = document.getElementById('ctaStamp');
        if (remaining === 1) {
          ctaEl.textContent = 'ðŸ”¥ One More Top Up to Unlock Your Reward!';
        } else {
          ctaEl.textContent = `${CONFIG.stampAction.ctaText} â€” Earn Your Next Stamp`;
        }

        // Fire viewed event
        pushEvent(CONFIG.events.stampCardViewed, {
          Current_Stamps: currentStamps,
          Total_Stamps: totalStamps,
          Pre_Filled: preFilledStamps,
          Remaining: remaining,
          Completion_Pct: Math.round((currentStamps / totalStamps) * 100),
        });
      }
    }

    // =============================================
    // REWARD SCREEN
    // =============================================
    function showRewardScreen() {
      const modal = document.getElementById('modal');
      modal.style.background = CONFIG.backgrounds.reward;

      // Hide stamps, show reward
      document.getElementById('screenStamps').classList.remove('active');
      const rewardScreen = document.getElementById('screenReward');
      rewardScreen.classList.add('active', 'screen-enter');

      // Populate
      document.getElementById('rewardTitle').textContent = CONFIG.reward.title;
      document.getElementById('rewardSubtitle').textContent = CONFIG.reward.subtitle;
      document.getElementById('promoCode').textContent = CONFIG.reward.promoCode;
      document.getElementById('expiryText').textContent = CONFIG.reward.expiryText;

      // Fire events
      pushEvent(CONFIG.events.stampCardCompleted, {
        Total_Stamps: totalStamps,
        Reward: CONFIG.reward.title,
        Promo_Code: CONFIG.reward.promoCode,
      });

      pushEvent(CONFIG.events.stampCardViewed, {
        Current_Stamps: totalStamps,
        Total_Stamps: totalStamps,
        Screen: 'reward',
      });

      // Confetti
      if (CONFIG.enableConfettiOnComplete) {
        setTimeout(() => fireConfetti(), 400);
      }
    }

    // =============================================
    // COPY CODE
    // =============================================
    window.copyCode = function () {
      const code = CONFIG.reward.promoCode;
      const btn = document.getElementById('copyBtn');

      // Copy to clipboard
      try {
        const textarea = document.createElement('textarea');
        textarea.value = code;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
      } catch (e) {
        // Fallback for newer browsers
        if (navigator.clipboard) {
          navigator.clipboard.writeText(code).catch(() => {});
        }
      }

      // Visual feedback
      btn.textContent = 'Copied!';
      btn.classList.add('copied');

      pushEvent(CONFIG.events.rewardCopied, {
        Promo_Code: code,
      });

      setTimeout(() => {
        btn.textContent = 'Copy';
        btn.classList.remove('copied');
      }, 3000);
    };

    // =============================================
    // CTA ACTIONS
    // =============================================
    window.ctaClick = function () {
      pushEvent(CONFIG.events.stampCardCtaClick, {
        Current_Stamps: currentStamps,
        Remaining: totalStamps - currentStamps,
        Action: 'top_up',
      });

      if (CONFIG.stampAction.ctaUrl) {
        window.location.href = CONFIG.stampAction.ctaUrl;
      }
    };

    window.redeemClick = function () {
      pushEvent(CONFIG.events.rewardRedeemed, {
        Promo_Code: CONFIG.reward.promoCode,
        Reward: CONFIG.reward.title,
      });

      if (CONFIG.reward.ctaUrl) {
        window.location.href = CONFIG.reward.ctaUrl;
      }
    };

    // =============================================
    // DISMISS
    // =============================================
    window.dismiss = function () {
      pushEvent(CONFIG.events.stampCardDismissed, {
        Screen: isComplete ? 'reward' : 'stamps',
        Current_Stamps: currentStamps,
      });

      try {
        if (typeof CleverTap !== 'undefined' && CleverTap.dismissInAppNotification) {
          CleverTap.dismissInAppNotification();
          return;
        }
      } catch (e) {}

      window.location.href = 'wzrk://exit';
    };

    // =============================================
    // CLEVERTAP EVENTS (dual-SDK safe)
    // =============================================
    function pushEvent(name, props) {
      const payload = props || {};
      payload.Timestamp = new Date().toISOString();
      payload.Campaign_ID = '{{ Campaign.campaignId }}';

      try {
        // Android SDK
        if (typeof CleverTap !== 'undefined' && CleverTap.pushEvent) {
          CleverTap.pushEvent(name, JSON.stringify(payload));
        }
        // Web SDK
        if (typeof clevertap !== 'undefined' && clevertap.event) {
          clevertap.event.push(name, payload);
        }
        // iOS SDK
        if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.clevertap) {
          window.webkit.messageHandlers.clevertap.postMessage(JSON.stringify({
            type: 'event', name: name, props: payload,
          }));
        }
      } catch (e) {
        console.log('[CT Event]', name, payload);
      }
    }

    // =============================================
    // CONFETTI
    // =============================================
    function fireConfetti() {
      if (typeof confetti === 'undefined') return;

      const canvas = document.getElementById('confettiCanvas');
      const myConfetti = confetti.create(canvas, { resize: true, useWorker: true });

      // Tune Talk red + turquoise burst
      myConfetti({
        particleCount: 70,
        spread: 90,
        origin: { y: 0.45 },
        colors: ['#E31937', '#30D5C8', '#FFD700', '#FFFFFF', '#FF6B8A'],
        ticks: 160,
      });

      setTimeout(() => {
        myConfetti({
          particleCount: 40,
          spread: 120,
          origin: { y: 0.5 },
          colors: ['#30D5C8', '#FFD700', '#E31937'],
          ticks: 120,
        });
      }, 300);
    }

    // =============================================
    // INIT
    // =============================================
    init();
  </script>
</body>
</html>
